<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Paris & Londres - Carte Interactive</title>
    
    <!-- PWA Configuration -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Paris & Londres">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Paris & Londres">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTciIGhlaWdodD0iNTciIHZpZXdCb3g9IjAgMCA1NyA1NyIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjU3IiBoZWlnaHQ9IjU3IiByeD0iMTAiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iNDEiIGhlaWdodD0iNDEiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiPgo8cGF0aCBkPSJNMTIgMmwtMyA5IDkgOWgtMTJsMy05aC05bDMtOUgxMnoiLz4KPC9zdmc+Cjwvc3ZnPg==">
    <link rel="apple-touch-icon" sizes="60x60" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iMTAiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iNDQiIGhlaWdodD0iNDQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiPgo8cGF0aCBkPSJNMTIgMmwtMyA5IDkgOWgtMTJsMy05aC05bDMtOUgxMnoiLz4KPC9zdmc+Cjwvc3ZnPg==">
    <link rel="apple-touch-icon" sizes="72x72" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzIiIGhlaWdodD0iNzIiIHZpZXdCb3g9IjAgMCA3MiA3MiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjcyIiBoZWlnaHQ9IjcyIiByeD0iMTIiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSIxMiIgeT0iMTIiIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAybC0zIDkgOSA5aC0xMmwzLTloLTlsMy05SDEyeiIvPgo8L3N2Zz4KPC9zdmc+">
    <link rel="apple-touch-icon" sizes="76x76" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzYiIGhlaWdodD0iNzYiIHZpZXdCb3g9IjAgMCA3NiA3NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9Ijc2IiBoZWlnaHQ9Ijc2IiByeD0iMTIiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSIxNCIgeT0iMTQiIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAybC0zIDkgOSA5aC0xMmwzLTloLTlsMy05SDEyeiIvPgo8L3N2Zz4KPC9zdmc+">
    <link rel="apple-touch-icon" sizes="114x114" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTE0IiBoZWlnaHQ9IjExNCIgdmlld0JveD0iMCAwIDExNCAxMTQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMTQiIGhlaWdodD0iMTE0IiByeD0iMTgiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI3NCIgaGVpZ2h0PSI3NCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAybC0zIDkgOSA5aC0xMmwzLTloLTlsMy05SDEyeiIvPgo8L3N2Zz4KPC9zdmc+">
    <link rel="apple-touch-icon" sizes="120x120" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiByeD0iMjAiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAybC0zIDkgOSA5aC0xMmwzLTloLTlsMy05SDEyeiIvPgo8L3N2Zz4KPC9zdmc+">
    <link rel="apple-touch-icon" sizes="144x144" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQ0IiBoZWlnaHQ9IjE0NCIgdmlld0JveD0iMCAwIDE0NCAxNDQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNDQiIGhlaWdodD0iMTQ0IiByeD0iMjQiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSIyNCIgeT0iMjQiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAybC0zIDkgOSA5aC0xMmwzLTloLTlsMy05SDEyeiIvPgo8L3N2Zz4KPC9zdmc+">
    <link rel="apple-touch-icon" sizes="152x152" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUyIiBoZWlnaHQ9IjE1MiIgdmlld0JveD0iMCAwIDE1MiAxNTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTIiIGhlaWdodD0iMTUyIiByeD0iMjQiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSIyNCIgeT0iMjQiIHdpZHRoPSIxMDQiIGhlaWdodD0iMTA0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KPHBhdGggZD0iTTEyIDJsLTMgOSA5IDloLTEybDMtOWgtOWwzLTlIMTJ6Ii8+Cjwvc3ZnPgo8L3N2Zz4K">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iMzAiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSIzMCIgeT0iMzAiIHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KPHBhdGggZD0iTTEyIDJsLTMgOSA5IDloLTEybDMtOWgtOWwzLTlIMTJ6Ii8+Cjwvc3ZnPgo8L3N2Zz4K">
    
    <!-- Standard Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNiIgZmlsbD0iIzY2N2VlYSIvPgo8c3ZnIHg9IjQiIHk9IjQiIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAybC0zIDkgOSA5aC0xMmwzLTloLTlsMy05SDEyeiIvPgo8L3N2Zz4KPC9zdmc+">
    <link rel="icon" type="image/png" sizes="16x16" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiByeD0iMyIgZmlsbD0iIzY2N2VlYSIvPgo8c3ZnIHg9IjIiIHk9IjIiIHdpZHRoPSIxMiIgaGVpZ2h0PSIxMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAybC0zIDkgOSA5aC0xMmwzLTloLTlsMy05SDEyeiIvPgo8L3N2Zz4KPC9zdmc+">
    
    <!-- iOS Splash Screens -->
    <link rel="apple-touch-startup-image" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTEyNSIgaGVpZ2h0PSIyNDM2IiB2aWV3Qm94PSIwIDAgMTEyNSAyNDM2IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTEyNSIgaGVpZ2h0PSIyNDM2IiBmaWxsPSIjNjY3ZWVhIi8+Cjx0ZXh0IHg9IjU2Mi41IiB5PSIxMjE4IiBmb250LWZhbWlseT0iLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQ4IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+UGFyaXMgJmFtcDsgTG9uZHJlczwvdGV4dD4KPHN2ZyB4PSI0NjAiIHk9IjEwNjAiIHdpZHRoPSIyMDUiIGhlaWdodD0iMjA1IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KPHBhdGggZD0iTTEyIDJsLTMgOSA5IDloLTEybDMtOWgtOWwzLTlIMTJ6Ii8+Cjwvc3ZnPgo8L3N2Zz4K" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI0MiIgaGVpZ2h0PSIyNjg4IiB2aWV3Qm94PSIwIDAgMTI0MiAyNjg4IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTI0MiIgaGVpZ2h0PSIyNjg4IiBmaWxsPSIjNjY3ZWVhIi8+Cjx0ZXh0IHg9IjYyMSIgeT0iMTM0NCIgZm9udC1mYW1pbHk9Ii1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI1MiIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPlBhcmlzICZhbXA7IExvbmRyZXM8L3RleHQ+Cjwvc3ZnPgo=" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTE3MCIgaGVpZ2h0PSIyNTMyIiB2aWV3Qm94PSIwIDAgMTE3MCAyNTMyIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTE3MCIgaGVpZ2h0PSIyNTMyIiBmaWxsPSIjNjY3ZWVhIi8+Cjx0ZXh0IHg9IjU4NSIgeT0iMTI2NiIgZm9udC1mYW1pbHk9Ii1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI1MCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPlBhcmlzICZhbXA7IExvbmRyZXM8L3RleHQ+Cjwvc3ZnPgo=" media="screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4NCIgaGVpZ2h0PSIyNzc4IiB2aWV3Qm94PSIwIDAgMTI4NCAyNzc4IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTI4NCIgaGVpZ2h0PSIyNzc4IiBmaWxsPSIjNjY3ZWVhIi8+Cjx0ZXh0IHg9IjY0MiIgeT0iMTM4OSIgZm9udC1mYW1pbHk9Ii1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI1NCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPlBhcmlzICZhbXA7IExvbmRyZXM8L3RleHQ+Cjwvc3ZnPgo=" media="screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    
    <!-- Manifest -->
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }

        .app-container {
            display: block;
            height: 100vh;
            position: relative;
            transition: padding-left 0.3s ease;
            padding-left: 350px;
        }

        .app-container.sidebar-collapsed {
            padding-left: 0;
        }

        /* Sidebar */
        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 1000;
            position: absolute;
            height: 100%;
            left: 0;
            top: 0;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .city-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .city-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            background: transparent;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .city-btn.active {
            background: white;
            color: #667eea;
            border-color: white;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 10px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f8f9ff;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* Map Container */
        .map-container {
            width: 100%;
            height: 100vh;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Controls */
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            background: white;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #333;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
        }

        .sidebar-toggle {
            position: absolute;
            top: 20px;
            left: 370px;
            z-index: 1001;
            transition: left 0.3s ease;
        }

        .sidebar-toggle.collapsed {
            left: 20px;
        }

        /* Categories */
        .category-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .category-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .category-info {
            flex: 1;
        }

        .category-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .category-count {
            font-size: 12px;
            color: #666;
        }

        /* Search */
        .search-container {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Location list */
        .location-item {
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .location-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .location-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .location-address {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .location-description {
            font-size: 13px;
            color: #555;
            line-height: 1.4;
        }

        .location-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .directions-btn {
            background: #4CAF50;
            color: white;
        }

        .directions-btn:hover {
            background: #45a049;
        }

        /* Responsive */
        /* iOS and Mobile Optimizations */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                width: 300px;
                transform: translateX(-100%);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .map-container {
                width: 100%;
            }

            .sidebar-toggle {
                left: 20px !important;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
            
            /* iOS Safe Area Support */
            .app-container {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: max(env(safe-area-inset-left), 0px);
                padding-right: max(env(safe-area-inset-right), 0px);
            }
            
            /* iPhone specific optimizations */
            .control-btn, .city-btn, .category-btn {
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
                min-height: 44px; /* Apple's minimum touch target */
                min-width: 44px;
            }
            
            /* Smooth scrolling for iOS */
            .sidebar-content {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
            }
            
            /* Search input iOS styling */
            input[type="text"], input[type="search"] {
                -webkit-appearance: none;
                border-radius: 10px;
                font-size: 16px; /* Prevent zoom on iOS */
            }
            
            /* Modal optimizations for mobile */
            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        /* iPhone X and newer - Notch support */
        @media screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3),
               screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2),
               screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3),
               screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3),
               screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) {
            
            .sidebar-toggle {
                top: max(env(safe-area-inset-top), 20px);
            }
            
            .control-buttons {
                bottom: max(env(safe-area-inset-bottom), 20px);
            }
        }

        /* PWA Standalone mode adjustments */
        .pwa-standalone .app-container {
            height: 100vh;
            overflow: hidden;
        }
        
        .pwa-standalone .sidebar-toggle {
            top: max(env(safe-area-inset-top), 10px);
        }

        /* Dark mode support for iOS */
        @media (prefers-color-scheme: dark) {
            .sidebar {
                background: rgba(28, 28, 30, 0.95);
                color: #ffffff;
            }
            
            .city-btn, .category-btn {
                background: rgba(58, 58, 60, 0.8);
                color: #ffffff;
            }
            
            .city-btn.active, .category-btn.active {
                background: #667eea;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .sidebar {
                border: 2px solid #000;
            }
            
            .city-btn, .category-btn, .control-btn {
                border: 1px solid #000;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

            .sidebar-toggle.collapsed {
                left: 20px !important;
            }
        }

        /* Custom popup styles */
        .custom-popup {
            min-width: 300px;
            max-width: 350px;
        }

        .popup-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 16px;
        }

        .popup-address {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .popup-description {
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 12px;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
        }

        .popup-info {
            margin-bottom: 12px;
            font-size: 12px;
        }

        .popup-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            padding: 4px 0;
        }

        .popup-info-item i {
            width: 16px;
            color: #667eea;
        }

        .popup-hours {
            background: #e8f5e8;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        .popup-phone {
            color: #1976d2;
            text-decoration: none;
        }

        .popup-phone:hover {
            text-decoration: underline;
        }

        .popup-website {
            color: #17a2b8;
            text-decoration: none;
        }

        .popup-website:hover {
            text-decoration: underline;
        }

        .popup-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .popup-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s ease;
        }

        .google-maps-btn {
            background: #4285f4;
            color: white;
        }

        .apple-maps-btn {
            background: #007aff;
            color: white;
        }

        .waze-btn {
            background: #33ccff;
            color: white;
        }

        .popup-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        /* Dark mode */
        .dark-mode {
            background: #1a1a1a;
            color: white;
        }

        .dark-mode .sidebar {
            background: #2d2d2d;
            border-right-color: #404040;
        }

        .dark-mode .category-item {
            background: #3d3d3d;
        }

        .dark-mode .location-item {
            background: #3d3d3d;
            color: white;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Toggle Button -->
        <button class="control-btn sidebar-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="city-switcher">
                    <button class="city-btn active" onclick="switchCity('paris')" id="parisBtn">
                        🗼 Paris
                    </button>
                    <button class="city-btn" onclick="switchCity('london')" id="londonBtn">
                        🏰 Londres
                    </button>
                </div>
                <div style="font-size: 14px; opacity: 0.9;">
                    Explorez les merveilles de Paris et Londres
                </div>
            </div>

            <div class="sidebar-tabs">
                <button class="tab-btn active" onclick="switchTab('itinerary')">
                    <i class="fas fa-route"></i><br>Itinéraire
                </button>
                <button class="tab-btn" onclick="switchTab('categories')">
                    <i class="fas fa-layer-group"></i><br>Catégories
                </button>
                <button class="tab-btn" onclick="switchTab('custom')">
                    <i class="fas fa-plus"></i><br>Mes Lieux
                </button>
                <button class="tab-btn" onclick="switchTab('planner')">
                    <i class="fas fa-map-marked-alt"></i><br>Planifier
                </button>
            </div>

            <div class="sidebar-content">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Rechercher un lieu..." onkeyup="searchLocations(this.value)">
                </div>

                <!-- Tab Contents -->
                <div id="itinerary-tab" class="tab-content">
                    <div class="loading">Chargement de l'itinéraire...</div>
                </div>

                <div id="categories-tab" class="tab-content" style="display: none;">
                    <div class="loading">Chargement des catégories...</div>
                </div>

                <div id="custom-tab" class="tab-content" style="display: none;">
                    <div class="loading">Chargement des lieux personnalisés...</div>
                </div>

                <div id="planner-tab" class="tab-content" style="display: none;">
                    <div class="loading">Chargement du planificateur...</div>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Map Controls -->
            <div class="map-controls">
                <button class="control-btn" onclick="locateUser()" title="Ma position">
                    <i class="fas fa-location-arrow"></i>
                </button>
                <button class="control-btn" onclick="toggleTheme()" title="Mode sombre/clair">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="control-btn" onclick="exportData()" title="Exporter données">
                    <i class="fas fa-download"></i>
                </button>
                <button class="control-btn" onclick="openPlaceSearch()" title="Rechercher un lieu">
                    <i class="fas fa-search"></i>
                </button>
                <button class="control-btn" onclick="addCustomLocation()" title="Ajouter lieu manuellement">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let currentCity = 'paris';
        let markers = {};
        let userLocation = null;
        let isDarkMode = false;
        let customLocations = JSON.parse(localStorage.getItem('customLocations') || '[]');

        // City configurations
        const cities = {
            paris: {
                center: [48.8844, 2.3424],
                zoom: 13,
                name: 'Paris'
            },
            london: {
                center: [51.5074, -0.1278],
                zoom: 12,
                name: 'Londres'
            }
        };

        // Categories with colors and icons
        const categories = {
            commerces: { name: 'Commerces Locaux', color: '#2E7D32', icon: '🏪', count: 0 },
            cafes: { name: 'Cafés Authentiques', color: '#1976D2', icon: '☕', count: 0 },
            boulangeries: { name: 'Boulangeries', color: '#F57C00', icon: '🥖', count: 0 },
            marches: { name: 'Marchés', color: '#7B1FA2', icon: '🛒', count: 0 },
            attractions: { name: 'Attractions Principales', color: '#D32F2F', icon: '🎭', count: 0 },
            musees: { name: 'Musées Famille', color: '#5D4037', icon: '🏛️', count: 0 },
            parcs: { name: 'Parcs & Détente', color: '#388E3C', icon: '🌳', count: 0 },
            quartiers: { name: 'Quartiers Authentiques', color: '#00796B', icon: '🏘️', count: 0 },
            photo_leica: { name: 'Magasins Leica Officiels', color: '#8B0000', icon: '📷', count: 0 },
            photo_vintage: { name: 'Photographie Vintage', color: '#7B1FA2', icon: '📷', count: 0 },
            photo_quartiers: { name: 'Quartiers Photo', color: '#00796B', icon: '📷', count: 0 },
            custom: { name: 'Mes Ajouts', color: '#FF6F00', icon: '📍', count: 0 }
        };

        // Initialize app
        function initApp() {
            initMap();
            loadLocations();
            setupEventListeners();
            updateUI();
        }

        // Initialize map
        function initMap() {
            const config = cities[currentCity];
            map = L.map('map').setView(config.center, config.zoom);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Custom marker styles
            L.Icon.Default.prototype.options.shadowSize = [0, 0];
        }

        // Switch between cities
        function switchCity(city) {
            if (city === currentCity) return;
            
            currentCity = city;
            const config = cities[city];
            
            // Update map view
            map.setView(config.center, config.zoom);
            
            // Update UI
            document.getElementById('parisBtn').classList.toggle('active', city === 'paris');
            document.getElementById('londonBtn').classList.toggle('active', city === 'london');
            
            // Clear and reload markers
            clearMarkers();
            loadLocations();
        }

        // Clear all markers
        function clearMarkers() {
            Object.values(markers).forEach(markerGroup => {
                markerGroup.forEach(marker => map.removeLayer(marker));
            });
            markers = {};
        }

        // Load locations based on current city
        function loadLocations() {
            const locations = currentCity === 'paris' ? getParisLocations() : getLondonLocations();
            
            // Reset category counts
            Object.keys(categories).forEach(cat => categories[cat].count = 0);
            
            // Add markers for each location
            locations.forEach(location => {
                addLocationMarker(location);
                categories[location.category].count++;
            });
            
            // Add custom locations
            customLocations.filter(loc => loc.city === currentCity).forEach(location => {
                addLocationMarker(location);
                categories.custom.count++;
            });
            
            updateCategoriesTab();
            updateItineraryTab();
        }

        // Add marker for a location
        function addLocationMarker(location) {
            const category = categories[location.category];
            
            // Create custom icon
            const icon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    background: ${category.color};
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    border: 3px solid white;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                    font-size: 14px;
                    cursor: pointer;
                ">${category.icon}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            // Create marker
            const marker = L.marker([location.lat, location.lng], { icon }).addTo(map);
            
            // Add click handler for selection mode
            marker.on('click', function() {
                if (isSelectionMode) {
                    addToSelection(location);
                    
                    // Visual feedback
                    const markerElement = marker.getElement();
                    if (markerElement) {
                        markerElement.style.transform = 'scale(1.2)';
                        setTimeout(() => {
                            markerElement.style.transform = 'scale(1)';
                        }, 200);
                    }
                }
            });
            
            // Create popup content
            const popupContent = createPopupContent(location);
            marker.bindPopup(popupContent, { className: 'custom-popup' });
            
            // Store marker
            if (!markers[location.category]) markers[location.category] = [];
            markers[location.category].push(marker);
        }

        // Create popup content
        function createPopupContent(location) {
            // Business info section
            let infoSection = '';
            if (location.phone || location.hours || location.website || location.specialty) {
                infoSection = '<div class="popup-info">';
                
                if (location.phone) {
                    infoSection += `
                        <div class="popup-info-item">
                            <i class="fas fa-phone"></i>
                            <a href="tel:${location.phone}" class="popup-phone">${location.phone}</a>
                        </div>
                    `;
                }
                
                if (location.hours) {
                    infoSection += `
                        <div class="popup-info-item">
                            <i class="fas fa-clock"></i>
                            <div class="popup-hours">${location.hours}</div>
                        </div>
                    `;
                }
                
                if (location.website) {
                    infoSection += `
                        <div class="popup-info-item">
                            <i class="fas fa-globe"></i>
                            <a href="${location.website}" target="_blank" class="popup-website">Site officiel</a>
                        </div>
                    `;
                }
                
                if (location.specialty) {
                    infoSection += `
                        <div class="popup-info-item">
                            <i class="fas fa-star"></i>
                            <span>${location.specialty}</span>
                        </div>
                    `;
                }
                
                infoSection += '</div>';
            }
            
            return `
                <div class="popup-header">${location.name}</div>
                <div class="popup-address">
                    <i class="fas fa-map-marker-alt"></i>
                    ${location.address}
                </div>
                <div class="popup-description">${location.description || ''}</div>
                ${infoSection}
                <div class="popup-actions">
                    <a href="#" class="popup-btn google-maps-btn" onclick="openDirections('google', ${location.lat}, ${location.lng})">
                        📍 Directions
                    </a>
                    <a href="#" class="popup-btn apple-maps-btn" onclick="openDirections('apple', ${location.lat}, ${location.lng})">
                        🍎 Apple Maps
                    </a>
                    <a href="#" class="popup-btn waze-btn" onclick="openDirections('waze', ${location.lat}, ${location.lng})">
                        🚗 Waze
                    </a>
                </div>
            `;
        }

        // Open directions in different apps
        function openDirections(service, lat, lng) {
            const coords = `${lat},${lng}`;
            let url;
            
            switch(service) {
                case 'google':
                    url = `https://www.google.com/maps/dir/?api=1&destination=${coords}`;
                    break;
                case 'apple':
                    url = `http://maps.apple.com/?daddr=${coords}&dirflg=w`;
                    break;
                case 'waze':
                    url = `https://waze.com/ul?ll=${coords}&navigate=yes`;
                    break;
            }
            
            window.open(url, '_blank');
        }

        // Open Google Maps search for business
        function openGoogleMapsSearch(name, address) {
            const searchQuery = `${name} ${address}`;
            const url = `https://www.google.com/maps/search/${encodeURIComponent(searchQuery)}`;
            window.open(url, '_blank');
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.querySelector('.sidebar-toggle');
            const appContainer = document.querySelector('.app-container');
            
            sidebar.classList.toggle('collapsed');
            toggleBtn.classList.toggle('collapsed');
            appContainer.classList.toggle('sidebar-collapsed');
            
            // Force map to resize after animation
            setTimeout(() => {
                if (window.map) {
                    map.invalidateSize();
                }
            }, 300);
        }

        // Switch tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // Load specific tab content
            switch(tabName) {
                case 'categories':
                    updateCategoriesTab();
                    break;
                case 'itinerary':
                    updateItineraryTab();
                    break;
                case 'custom':
                    updateCustomTab();
                    break;
                case 'planner':
                    updatePlannerTab();
                    break;
            }
        }

        // Update categories tab
        function updateCategoriesTab() {
            const content = document.getElementById('categories-tab');
            const categoriesHtml = Object.entries(categories).map(([key, cat]) => {
                if (cat.count === 0 && key !== 'custom') return '';
                return `
                    <div class="category-item" onclick="filterByCategory('${key}')">
                        <div class="category-icon" style="background: ${cat.color}">
                            ${cat.icon}
                        </div>
                        <div class="category-info">
                            <div class="category-name">${cat.name}</div>
                            <div class="category-count">${cat.count} lieu(s)</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            content.innerHTML = categoriesHtml || '<div class="loading">Aucune catégorie disponible</div>';
        }

        // Update itinerary tab
        function updateItineraryTab() {
            const content = document.getElementById('itinerary-tab');
            const locations = currentCity === 'paris' ? getParisLocations() : getLondonLocations();
            
            // Filter out cafes, restaurants, boulangeries, commerces, and marches from itinerary
            const filteredLocations = locations.filter(loc => 
                !['cafes', 'boulangeries', 'commerces', 'marches'].includes(loc.category)
            );
            
            // Group by day if available
            const groupedByDay = {};
            filteredLocations.forEach(loc => {
                const day = loc.day || 'Autres';
                if (!groupedByDay[day]) groupedByDay[day] = [];
                groupedByDay[day].push(loc);
            });
            
            let html = '';
            
            // Define custom order for days
            const dayOrder = ['Jour 1', 'Jour 2', 'Jour 3', 'Jour 4', 'Jour 5', 'Jour 6', 'Jour 7', 'Autres'];
            
            // Sort days according to custom order
            const sortedDays = dayOrder.filter(day => groupedByDay[day] && groupedByDay[day].length > 0);
            
            sortedDays.forEach(day => {
                const locs = groupedByDay[day];
                html += `<h3 style="margin: 20px 0 10px 0; color: #667eea;">${day}</h3>`;
                locs.forEach(loc => {
                    html += createLocationItem(loc);
                });
            });
            
            content.innerHTML = html || '<div class="loading">Aucun itinéraire disponible</div>';
        }

        // Update custom tab
        function updateCustomTab() {
            const content = document.getElementById('custom-tab');
            const userLocations = customLocations.filter(loc => loc.city === currentCity);
            
            let html = `
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="action-btn" onclick="openPlaceSearch()" style="flex: 1; background: #28a745; color: white; padding: 12px;">
                        <i class="fas fa-search"></i> Rechercher
                    </button>
                    <button class="action-btn" onclick="addCustomLocation()" style="flex: 1; background: #667eea; color: white; padding: 12px;">
                        <i class="fas fa-plus"></i> Ajouter
                    </button>
                </div>
            `;
            
            if (userLocations.length > 0) {
                userLocations.forEach(loc => {
                    html += createLocationItem(loc, true);
                });
            } else {
                html += '<div class="loading">Aucun lieu personnalisé ajouté</div>';
            }
            
            content.innerHTML = html;
        }

        // Update planner tab
        function updatePlannerTab() {
            const content = document.getElementById('planner-tab');
            const locations = currentCity === 'paris' ? getParisLocations() : getLondonLocations();
            
            content.innerHTML = `
                <div style="padding: 10px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">📍 Planificateur Multi-étapes</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <button class="action-btn" onclick="selectMultipleLocations()" style="width: 100%; background: #667eea; color: white; padding: 12px; margin-bottom: 10px;">
                            🗺️ Sélectionner des lieux
                        </button>
                        <div id="selected-locations" style="max-height: 150px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                            <p style="color: #666; text-align: center; margin: 0;">Aucun lieu sélectionné</p>
                        </div>
                        <button class="action-btn" onclick="optimizeRoute()" style="width: 100%; background: #28a745; color: white; padding: 12px; margin-bottom: 10px;" disabled>
                            🚀 Optimiser l'itinéraire
                        </button>
                        <button class="action-btn" onclick="clearSelection()" style="width: 100%; background: #dc3545; color: white; padding: 12px;">
                            🗑️ Effacer sélection
                        </button>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #1976d2;">💡 Conseils d'optimisation</h4>
                        <ul style="margin: 0; padding-left: 15px; font-size: 13px; color: #555;">
                            <li>Groupez les lieux par quartier</li>
                            <li>Commencez par les horaires fixes</li>
                            <li>Prévoyez du temps de transport</li>
                            <li>Considérez les heures d'affluence</li>
                        </ul>
                    </div>
                    
                    <div id="optimized-route" style="display: none;">
                        <h4 style="color: #28a745; margin-bottom: 10px;">🎯 Itinéraire Optimisé</h4>
                        <div id="route-details"></div>
                        <button class="action-btn" onclick="exportRoute()" style="background: #667eea; color: white; padding: 10px 15px; margin-top: 10px;">
                            📤 Exporter l'itinéraire
                        </button>
                    </div>
                </div>
            `;
        }

        // Multi-location selection variables
        let selectedLocations = [];
        let isSelectionMode = false;

        // Start multi-location selection
        function selectMultipleLocations() {
            isSelectionMode = !isSelectionMode;
            const btn = event.target;
            
            if (isSelectionMode) {
                btn.textContent = '✅ Terminer sélection';
                btn.style.background = '#ffc107';
                alert('Cliquez sur les marqueurs pour les ajouter à votre itinéraire !');
            } else {
                btn.textContent = '🗺️ Sélectionner des lieux';
                btn.style.background = '#667eea';
            }
            
            updateSelectedLocationsDisplay();
        }

        // Add location to selection (called when marker is clicked in selection mode)
        function addToSelection(location) {
            if (!isSelectionMode) return;
            
            const exists = selectedLocations.find(loc => loc.lat === location.lat && loc.lng === location.lng);
            if (!exists) {
                selectedLocations.push(location);
                updateSelectedLocationsDisplay();
            }
        }

        // Update selected locations display
        function updateSelectedLocationsDisplay() {
            const container = document.getElementById('selected-locations');
            const optimizeBtn = document.querySelector('button[onclick="optimizeRoute()"]');
            
            if (selectedLocations.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; margin: 0;">Aucun lieu sélectionné</p>';
                optimizeBtn.disabled = true;
                optimizeBtn.style.opacity = '0.5';
            } else {
                const html = selectedLocations.map((loc, index) => `
                    <div style="display: flex; align-items: center; margin-bottom: 8px; padding: 8px; background: white; border-radius: 5px;">
                        <span style="margin-right: 8px; font-weight: bold; color: #667eea;">${index + 1}.</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 13px;">${loc.name}</div>
                            <div style="font-size: 11px; color: #666;">${categories[loc.category].name}</div>
                        </div>
                        <button onclick="removeFromSelection(${index})" style="background: #dc3545; color: white; border: none; border-radius: 3px; padding: 4px 8px; font-size: 10px;">❌</button>
                    </div>
                `).join('');
                
                container.innerHTML = html;
                optimizeBtn.disabled = false;
                optimizeBtn.style.opacity = '1';
            }
        }

        // Remove location from selection
        function removeFromSelection(index) {
            selectedLocations.splice(index, 1);
            updateSelectedLocationsDisplay();
        }

        // Clear all selections
        function clearSelection() {
            selectedLocations = [];
            isSelectionMode = false;
            updateSelectedLocationsDisplay();
            
            const btn = document.querySelector('button[onclick="selectMultipleLocations()"]');
            if (btn) {
                btn.textContent = '🗺️ Sélectionner des lieux';
                btn.style.background = '#667eea';
            }
            
            document.getElementById('optimized-route').style.display = 'none';
        }

        // Optimize route (simple algorithm - could be improved with real routing)
        function optimizeRoute() {
            if (selectedLocations.length < 2) {
                alert('Sélectionnez au moins 2 lieux pour optimiser !');
                return;
            }
            
            // Simple optimization: group by category and day, then by geographical proximity
            const optimized = [...selectedLocations].sort((a, b) => {
                if (a.day !== b.day) return a.day.localeCompare(b.day);
                if (a.category !== b.category) return a.category.localeCompare(b.category);
                return 0;
            });
            
            displayOptimizedRoute(optimized);
        }

        // Display optimized route
        function displayOptimizedRoute(route) {
            const container = document.getElementById('route-details');
            const routeDiv = document.getElementById('optimized-route');
            
            let totalDistance = 0;
            let html = '';
            
            route.forEach((location, index) => {
                const category = categories[location.category];
                const isLast = index === route.length - 1;
                
                if (index > 0) {
                    const prev = route[index - 1];
                    const distance = calculateDistance(prev.lat, prev.lng, location.lat, location.lng);
                    totalDistance += distance;
                    
                    html += `
                        <div style="display: flex; align-items: center; margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 5px;">
                            <div style="width: 30px; text-align: center;">🚶‍♂️</div>
                            <div style="font-size: 12px; color: #666;">
                                ${distance.toFixed(1)} km - ~${Math.ceil(distance * 12)} min à pied
                            </div>
                        </div>
                    `;
                }
                
                html += `
                    <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid ${category.color};">
                        <div style="width: 40px; height: 40px; background: ${category.color}; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: white; font-size: 16px;">
                            ${category.icon}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${index + 1}. ${location.name}</div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">${location.address}</div>
                            <div style="font-size: 11px; background: ${category.color}20; color: ${category.color}; padding: 2px 8px; border-radius: 10px; display: inline-block;">
                                ${category.name} • ${location.day}
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <button onclick="openDirections('google', ${location.lat}, ${location.lng})" style="background: #4285f4; color: white; border: none; padding: 6px 10px; font-size: 10px; border-radius: 4px;">
                                📍 Maps
                            </button>
                            <button onclick="focusOnLocation(${location.lat}, ${location.lng})" style="background: #28a745; color: white; border: none; padding: 6px 10px; font-size: 10px; border-radius: 4px;">
                                👁️ Voir
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html = `
                <div style="background: #d4edda; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                    <strong>Distance totale estimée: ${totalDistance.toFixed(1)} km</strong><br>
                    <span style="font-size: 12px; color: #155724;">Temps de marche: ~${Math.ceil(totalDistance * 12)} minutes</span>
                </div>
            ` + html;
            
            container.innerHTML = html;
            routeDiv.style.display = 'block';
        }

        // Calculate distance between two points (Haversine formula)
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Export route
        function exportRoute() {
            if (selectedLocations.length === 0) return;
            
            const routeData = {
                city: currentCity,
                locations: selectedLocations,
                exportDate: new Date().toISOString(),
                totalLocations: selectedLocations.length
            };
            
            const blob = new Blob([JSON.stringify(routeData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `itineraire-${currentCity}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Create location item HTML
        function createLocationItem(location, isCustom = false) {
            const category = categories[location.category];
            return `
                <div class="location-item" onclick="focusOnLocation(${location.lat}, ${location.lng})" style="border-left-color: ${category.color}">
                    <div class="location-name">${category.icon} ${location.name}</div>
                    <div class="location-address">${location.address}</div>
                    <div class="location-description">${location.description || ''}</div>
                    <div class="location-actions">
                        <button class="action-btn directions-btn" onclick="event.stopPropagation(); openDirections('google', ${location.lat}, ${location.lng})">
                            📍 Directions
                        </button>
                        ${isCustom ? `<button class="action-btn" style="background: #f44336; color: white;" onclick="event.stopPropagation(); removeCustomLocation('${location.id}')">🗑️ Supprimer</button>` : ''}
                    </div>
                </div>
            `;
        }

        // Focus on location
        function focusOnLocation(lat, lng) {
            map.setView([lat, lng], 16);
        }

        // Filter by category
        function filterByCategory(category) {
            // Hide all markers
            Object.values(markers).forEach(markerGroup => {
                markerGroup.forEach(marker => map.removeLayer(marker));
            });
            
            // Show only selected category
            if (markers[category]) {
                markers[category].forEach(marker => marker.addTo(map));
            }
            
            // Focus on first marker of category
            if (markers[category] && markers[category].length > 0) {
                const firstMarker = markers[category][0];
                map.setView(firstMarker.getLatLng(), 15);
            }
        }

        // Search locations
        function searchLocations(query) {
            if (!query) {
                // Show all markers
                Object.values(markers).forEach(markerGroup => {
                    markerGroup.forEach(marker => marker.addTo(map));
                });
                return;
            }
            
            // Hide all markers
            Object.values(markers).forEach(markerGroup => {
                markerGroup.forEach(marker => map.removeLayer(marker));
            });
            
            // Show matching markers
            const locations = currentCity === 'paris' ? getParisLocations() : getLondonLocations();
            const allLocations = [...locations, ...customLocations.filter(loc => loc.city === currentCity)];
            
            allLocations.forEach((location, index) => {
                if (location.name.toLowerCase().includes(query.toLowerCase()) || 
                    location.description.toLowerCase().includes(query.toLowerCase())) {
                    
                    const categoryMarkers = markers[location.category];
                    if (categoryMarkers) {
                        const marker = categoryMarkers.find(m => 
                            m.getLatLng().lat === location.lat && m.getLatLng().lng === location.lng
                        );
                        if (marker) marker.addTo(map);
                    }
                }
            });
        }

        // Locate user
        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = [position.coords.latitude, position.coords.longitude];
                        map.setView(userLocation, 16);
                        
                        // Add user marker
                        if (window.userMarker) map.removeLayer(window.userMarker);
                        window.userMarker = L.marker(userLocation, {
                            icon: L.divIcon({
                                className: 'user-marker',
                                html: '<div style="background: #667eea; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(map);
                        
                        window.userMarker.bindPopup('Votre position').openPopup();
                    },
                    (error) => {
                        alert('Impossible d\'obtenir votre position');
                    }
                );
            }
        }

        // Add custom location with improved interface
        function addCustomLocation() {
            const modal = createLocationModal();
            document.body.appendChild(modal);
        }

        // Open search modal for places
        function openPlaceSearch() {
            const modal = createSearchModal();
            document.body.appendChild(modal);
        }

        // Create search modal for finding places
        function createSearchModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    padding: 25px;
                    width: 90%;
                    max-width: 600px;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #333;">🔍 Rechercher un lieu</h3>
                        <button onclick="closeSearchModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">×</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="placeSearchInput" placeholder="Ex: Tour Eiffel, Restaurant Chez Paul, Covent Garden..." 
                                style="flex: 1; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                                onkeypress="if(event.key==='Enter') searchPlaces()">
                            <button onclick="searchPlaces()" style="padding: 12px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                🔍 Chercher
                            </button>
                        </div>
                        
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="setSearchArea('paris')" class="area-btn" style="padding: 6px 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 20px; font-size: 12px; cursor: pointer;">
                                🗼 Paris
                            </button>
                            <button onclick="setSearchArea('london')" class="area-btn" style="padding: 6px 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 20px; font-size: 12px; cursor: pointer;">
                                🏰 Londres
                            </button>
                            <button onclick="setSearchArea('current')" class="area-btn" style="padding: 6px 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 20px; font-size: 12px; cursor: pointer;">
                                📍 Zone actuelle
                            </button>
                        </div>
                    </div>
                    
                    <div id="searchResults" style="min-height: 100px;">
                        <div style="text-align: center; color: #666; padding: 40px 20px;">
                            💡 Tapez le nom d'un lieu que vous souhaitez ajouter à votre carte.<br>
                            <small>Ex: "Restaurant Chez Paul Paris", "Covent Garden London", "Musée du Louvre"</small>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                        <div style="background: #f0f8ff; padding: 12px; border-radius: 6px; font-size: 12px; color: #666;">
                            <strong>💡 Conseils de recherche :</strong><br>
                            • Soyez précis : "Restaurant Le Procope Paris" plutôt que "restaurant"<br>
                            • Ajoutez la ville : "Big Ben Londres" ou "Tour Eiffel Paris"<br>
                            • Essayez en français ET en anglais pour Londres
                        </div>
                    </div>
                </div>
            `;
            
            return modal;
        }

        // Close search modal
        function closeSearchModal() {
            const modal = document.querySelector('div[style*="position: fixed"][style*="z-index: 10000"]');
            if (modal) modal.remove();
        }

        // Set search area
        function setSearchArea(area) {
            const input = document.getElementById('placeSearchInput');
            const currentQuery = input.value;
            
            // Update button styles
            document.querySelectorAll('.area-btn').forEach(btn => {
                btn.style.background = '#f8f9fa';
                btn.style.color = '#333';
            });
            
            event.target.style.background = '#667eea';
            event.target.style.color = 'white';
            
            // Add area to search if not already present
            if (area === 'paris' && !currentQuery.toLowerCase().includes('paris')) {
                input.value = currentQuery + (currentQuery ? ' Paris' : 'Paris');
            } else if (area === 'london' && !currentQuery.toLowerCase().includes('london') && !currentQuery.toLowerCase().includes('londres')) {
                input.value = currentQuery + (currentQuery ? ' London' : 'London');
            }
            
            input.focus();
        }

        // Search for places using Nominatim
        async function searchPlaces() {
            const query = document.getElementById('placeSearchInput').value.trim();
            const resultsDiv = document.getElementById('searchResults');
            
            if (!query) {
                resultsDiv.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">❌ Veuillez saisir un terme de recherche</div>';
                return;
            }
            
            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <div style="margin-top: 15px; color: #666;">Recherche en cours...</div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            
            try {
                // Search with bias towards current city
                const cityBias = currentCity === 'paris' ? ', France' : ', UK';
                const searchQuery = query.includes('Paris') || query.includes('London') || query.includes('Londres') ? query : query + cityBias;
                
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=8&addressdetails=1&extratags=1`);
                const results = await response.json();
                
                if (results && results.length > 0) {
                    displaySearchResults(results);
                } else {
                    resultsDiv.innerHTML = `
                        <div style="text-align: center; color: #dc3545; padding: 30px;">
                            ❌ Aucun résultat trouvé pour "${query}"<br>
                            <small style="color: #666; margin-top: 10px; display: block;">
                                Essayez d'être plus précis ou vérifiez l'orthographe
                            </small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 30px;">
                        ❌ Erreur de recherche<br>
                        <small style="color: #666;">Vérifiez votre connexion internet</small>
                    </div>
                `;
            }
        }

        // Display search results
        function displaySearchResults(results) {
            const resultsDiv = document.getElementById('searchResults');
            
            let html = `<div style="margin-bottom: 15px; font-weight: 600; color: #333;">📍 ${results.length} résultat(s) trouvé(s) :</div>`;
            
            results.forEach((result, index) => {
                const name = result.display_name.split(',')[0];
                const address = result.display_name;
                const lat = parseFloat(result.lat);
                const lng = parseFloat(result.lon);
                const type = result.type || 'lieu';
                
                // Determine icon based on type
                let icon = '📍';
                if (result.type === 'restaurant' || result.class === 'amenity') icon = '🍽️';
                else if (result.type === 'tourism' || result.class === 'tourism') icon = '🎭';
                else if (result.type === 'shop' || result.class === 'shop') icon = '🏪';
                else if (result.type === 'leisure' || result.class === 'leisure') icon = '🎯';
                
                html += `
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; padding: 15px; cursor: pointer; transition: all 0.3s ease;" 
                         onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'; this.style.transform='translateY(-2px)'"
                         onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)'"
                         onclick="selectSearchResult('${name.replace(/'/g, "\\'")}', '${address.replace(/'/g, "\\'")}', ${lat}, ${lng}, '${type}', '${icon}')">
                        
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <div style="font-size: 24px;">${icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${name}</div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 6px;">${address}</div>
                                <div style="font-size: 11px; background: #f8f9fa; color: #666; padding: 2px 8px; border-radius: 10px; display: inline-block;">
                                    ${type} • ${(calculateDistance(map.getCenter().lat, map.getCenter().lng, lat, lng)).toFixed(1)} km
                                </div>
                            </div>
                            <div style="color: #667eea; font-size: 20px;">→</div>
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }

        // Select a search result and open add form
        function selectSearchResult(name, address, lat, lng, type, icon) {
            closeSearchModal();
            
            // Open the add location modal with pre-filled data
            const modal = createLocationModal();
            document.body.appendChild(modal);
            
            // Pre-fill the form
            setTimeout(() => {
                document.getElementById('customLocationName').value = name;
                document.getElementById('customLocationAddress').value = address;
                document.getElementById('customLocationSpecialty').value = `Type: ${type}`;
                
                // Store coordinates for later use
                window.tempCoordinates = { lat, lng };
            }, 100);
        }

        // Create modal for adding custom location
        function createLocationModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    padding: 25px;
                    width: 90%;
                    max-width: 450px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #333;">📍 Ajouter un lieu</h3>
                        <button onclick="closeLocationModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">×</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Nom du lieu *</label>
                        <input type="text" id="customLocationName" placeholder="Ex: Mon restaurant préféré" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Adresse *</label>
                        <input type="text" id="customLocationAddress" placeholder="Ex: 123 rue de la Paix, 75001 Paris" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                        <div style="margin-top: 8px; display: flex; gap: 8px;">
                            <button onclick="closeLocationModal(); openPlaceSearch()" style="padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; flex: 1;">
                                🔍 Rechercher dans l'app
                            </button>
                            <button onclick="searchAddressOnGoogleMaps()" style="padding: 6px 12px; background: #34a853; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; flex: 1;">
                                🌐 Google Maps
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Téléphone</label>
                        <input type="tel" id="customLocationPhone" placeholder="Ex: 01 23 45 67 89" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Horaires</label>
                        <input type="text" id="customLocationHours" placeholder="Ex: Lun-Ven: 9h-18h" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Site web</label>
                        <input type="url" id="customLocationWebsite" placeholder="Ex: https://www.exemple.com" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Description</label>
                        <textarea id="customLocationDescription" placeholder="Décrivez ce lieu, pourquoi vous le recommandez..." style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; height: 80px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Spécialité</label>
                        <input type="text" id="customLocationSpecialty" placeholder="Ex: Cuisine italienne, Service de qualité" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="background: #f0f8ff; padding: 12px; border-radius: 6px; font-size: 12px; color: #666;">
                            💡 <strong>Astuce :</strong> Utilisez le bouton "Rechercher sur Google Maps" pour vérifier l'adresse et obtenir les coordonnées exactes.
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeLocationModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Annuler
                        </button>
                        <button onclick="saveCustomLocation()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            💾 Enregistrer
                        </button>
                    </div>
                </div>
            `;
            
            return modal;
        }

        // Close location modal
        function closeLocationModal() {
            const modal = document.querySelector('div[style*="position: fixed"][style*="z-index: 10000"]');
            if (modal) modal.remove();
        }

        // Search address on Google Maps
        function searchAddressOnGoogleMaps() {
            const address = document.getElementById('customLocationAddress').value;
            if (!address) {
                alert('Veuillez saisir une adresse à rechercher');
                return;
            }
            
            const searchUrl = `https://www.google.com/maps/search/${encodeURIComponent(address)}`;
            window.open(searchUrl, '_blank');
        }

        // Geocode address using Nominatim (OpenStreetMap)
        async function geocodeAddress(address) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        // Save custom location
        async function saveCustomLocation() {
            const name = document.getElementById('customLocationName').value.trim();
            const address = document.getElementById('customLocationAddress').value.trim();
            const phone = document.getElementById('customLocationPhone').value.trim();
            const hours = document.getElementById('customLocationHours').value.trim();
            const website = document.getElementById('customLocationWebsite').value.trim();
            const description = document.getElementById('customLocationDescription').value.trim();
            const specialty = document.getElementById('customLocationSpecialty').value.trim();
            
            if (!name || !address) {
                alert('Le nom et l\'adresse sont obligatoires');
                return;
            }
            
            // Show loading
            const saveBtn = event.target;
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '⏳ Géocodage...';
            saveBtn.disabled = true;
            
            let coordinates;
            
            // Use pre-found coordinates if available (from search)
            if (window.tempCoordinates) {
                coordinates = window.tempCoordinates;
                window.tempCoordinates = null; // Clear after use
            } else {
                // Try to geocode the address
                coordinates = await geocodeAddress(address);
                
                if (!coordinates) {
                    // Fallback to current map center or user location
                    const center = userLocation || map.getCenter();
                    coordinates = {
                        lat: typeof center.lat === 'function' ? center.lat() : center[0],
                        lng: typeof center.lng === 'function' ? center.lng() : center[1]
                    };
                    
                    if (!confirm('Impossible de géocoder l\'adresse automatiquement. Utiliser la position actuelle de la carte ?')) {
                        saveBtn.innerHTML = originalText;
                        saveBtn.disabled = false;
                        return;
                    }
                }
            }
            
            const customLocation = {
                id: Date.now().toString(),
                name,
                address,
                description,
                phone: phone || undefined,
                hours: hours || undefined,
                website: website || undefined,
                specialty: specialty || undefined,
                lat: coordinates.lat,
                lng: coordinates.lng,
                category: 'custom',
                city: currentCity,
                created: new Date().toISOString()
            };
            
            customLocations.push(customLocation);
            localStorage.setItem('customLocations', JSON.stringify(customLocations));
            
            // Add marker
            addLocationMarker(customLocation);
            categories.custom.count++;
            
            updateCategoriesTab();
            updateCustomTab();
            
            // Focus on the new location
            map.setView([coordinates.lat, coordinates.lng], 16);
            
            closeLocationModal();
            
            // Show success message
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10001;
                font-weight: 600;
            `;
            successDiv.innerHTML = '✅ Lieu ajouté avec succès !';
            document.body.appendChild(successDiv);
            
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Remove custom location
        function removeCustomLocation(id) {
            customLocations = customLocations.filter(loc => loc.id !== id);
            localStorage.setItem('customLocations', JSON.stringify(customLocations));
            
            // Reload locations
            clearMarkers();
            loadLocations();
        }

        // Toggle theme
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            
            const icon = document.querySelector('.map-controls button[onclick="toggleTheme()"] i');
            icon.className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
        }

        // Export data
        function exportData() {
            const data = {
                customLocations,
                currentCity,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `paris-london-map-${currentCity}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Setup event listeners
        function setupEventListeners() {
            // File import
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.customLocations) {
                            customLocations = data.customLocations;
                            localStorage.setItem('customLocations', JSON.stringify(customLocations));
                            clearMarkers();
                            loadLocations();
                            alert('Données importées avec succès !');
                        }
                    } catch (error) {
                        alert('Erreur lors de l\'importation du fichier');
                    }
                };
                reader.readAsText(file);
            });
            
            window.importData = () => fileInput.click();
        }

        // Update UI
        function updateUI() {
            // Update city button states
            document.getElementById('parisBtn').classList.toggle('active', currentCity === 'paris');
            document.getElementById('londonBtn').classList.toggle('active', currentCity === 'london');
        }

        // Data functions (simplified - in real app these would be in separate files)
        function getParisLocations() {
            return [
                // Commerces Locaux
                { 
                    name: "L'Épicerie des Environs", 
                    address: "22 rue Ramey, 75018 Paris", 
                    description: "Épicerie fine proposant exclusivement des produits locaux d'Île-de-France. Sandrine, la propriétaire, sélectionne personnellement chaque producteur.", 
                    lat: 48.8921, lng: 2.3416, category: "commerces", day: "Jour 1",
                    phone: "01 42 57 48 39",
                    hours: "Mar-Sam: 9h-19h30, Dim: 9h-13h, Lun: fermé",
                    specialty: "Produits locaux Île-de-France, sélection artisanale"
                },
                { 
                    name: "Racines", 
                    address: "98 rue Marcadet, 75018 Paris", 
                    description: "Concept store 100% français tenu par Laura et Max. Épicerie, cosmétiques et objets de créateurs français uniquement.", 
                    lat: 48.8897, lng: 2.3387, category: "commerces", day: "Jour 1",
                    phone: "01 42 59 14 75",
                    hours: "Mar-Sam: 10h-20h, Dim: 10h-14h, Lun: fermé",
                    specialty: "100% Made in France, créateurs locaux, cosmétiques naturels"
                },
                { 
                    name: "Bizas - La Vie de Quartier", 
                    address: "25 rue Custine, 75018 Paris", 
                    description: "Espace communautaire de 110m² mêlant épicerie, café et lieu de rencontre. Événements culturels et ateliers réguliers.", 
                    lat: 48.8889, lng: 2.3445, category: "commerces", day: "Jour 1",
                    phone: "01 42 64 87 96",
                    hours: "Lun-Sam: 8h-20h, Dim: 9h-18h",
                    specialty: "Espace communautaire 110m², événements, ateliers"
                },
                { 
                    name: "Médaille d'or", 
                    address: "43 rue Lepic, 75018 Paris", 
                    description: "Épicerie fine spécialisée dans les produits primés aux concours agricoles nationaux. Qualité exceptionnelle garantie.", 
                    lat: 48.8844, lng: 2.3356, category: "commerces", day: "Jour 1",
                    phone: "01 46 06 32 27",
                    hours: "Mar-Sam: 9h30-19h30, Dim: 9h30-13h, Lun: fermé",
                    specialty: "Produits médaillés concours nationaux, qualité premium"
                },
                
                // Cafés Authentiques
                { 
                    name: "Lux Bar", 
                    address: "12 rue Lepic, 75018 Paris", 
                    description: "Bar historique avec fresques centenaires authentiques. Fréquenté par de vrais Montmartrois, ambiance village parisien préservée.", 
                    lat: 48.8844, lng: 2.3356, category: "cafes", day: "Jour 1",
                    phone: "01 46 06 05 15",
                    hours: "Lun-Dim: 7h-2h",
                    specialty: "Fresques centenaires, authentique Montmartre, clientèle locale"
                },
                { 
                    name: "Café Tabac", 
                    address: "1bis rue Ravignan, 75018 Paris", 
                    description: "Café dans un bâtiment penché typiquement montmartrois. Architecture unique et charme d'antan préservé.", 
                    lat: 48.8867, lng: 2.3365, category: "cafes", day: "Jour 1",
                    phone: "01 42 57 15 47",
                    hours: "Lun-Dim: 6h30-20h",
                    specialty: "Bâtiment tordu historique, architecture unique Montmartre"
                },
                { 
                    name: "Sylon de Montmartre", 
                    address: "4bis rue Piemontesi, 75018 Paris", 
                    description: "Café nouvelle génération mais respectueux des traditions montmartroises. Accueil chaleureux et produits de qualité.", 
                    lat: 48.8856, lng: 2.3389, category: "cafes", day: "Jour 1",
                    phone: "01 42 54 88 96",
                    hours: "Lun-Dim: 7h-19h",
                    specialty: "Nouvelle génération authentique, respect des traditions"
                },
                { 
                    name: "Les Cinq Marches", 
                    address: "12 rue Girardon, 75018 Paris", 
                    description: "Petit café de quartier où le personnel vous fait vraiment sentir chez vous. Ambiance familiale et conviviale unique.", 
                    lat: 48.8878, lng: 2.3389, category: "cafes", day: "Jour 1",
                    phone: "01 42 55 03 47",
                    hours: "Mar-Dim: 8h-18h, Lun: fermé",
                    specialty: "Accueil familial, ambiance comme à la maison"
                },
                
                // Boulangeries
                { 
                    name: "Le Pétrin Médiéval", 
                    address: "31 rue Henri Monnier, 75009 Paris", 
                    description: "Boulangerie artisanale avec four en pierre historique de 1909. Pain cuit au feu de bois selon les méthodes ancestrales.", 
                    lat: 48.8789, lng: 2.3367, category: "boulangeries", day: "Jour 2",
                    phone: "01 48 78 35 06",
                    hours: "Mar-Sam: 7h-19h30, Dim: 7h-13h, Lun: fermé",
                    specialty: "Four pierre 1909, cuisson feu de bois, méthodes ancestrales"
                },
                { 
                    name: "Boulangerie Alexine", 
                    address: "40 rue Lepic, 75018 Paris", 
                    description: "4e place au concours de la Meilleure Baguette de Paris. Boulangerie de quartier reconnue pour sa qualité.", 
                    lat: 48.8844, lng: 2.3356, category: "boulangeries", day: "Jour 2",
                    phone: "01 46 06 45 98",
                    hours: "Mar-Dim: 7h-20h, Lun: fermé",
                    specialty: "4e Meilleure Baguette Paris, boulangerie de quartier"
                },
                { 
                    name: "Le Grenier à Pain", 
                    address: "38 rue des Abbesses, 75018 Paris", 
                    description: "Vainqueur du concours du Meilleur Croissant et de la Meilleure Baguette de Paris. Excellence reconnue.", 
                    lat: 48.8844, lng: 2.3387, category: "boulangeries", day: "Jour 2",
                    phone: "01 46 06 41 81",
                    hours: "Lun-Dim: 7h30-20h",
                    specialty: "Meilleur Croissant et Baguette Paris, excellence reconnue"
                },
                { 
                    name: "Chamboule", 
                    address: "54 rue Custine, 75018 Paris", 
                    description: "Nouvelle boulangerie artisanale ouverte en 2024. Spécialiste du pain au levain naturel et sourdough.", 
                    lat: 48.8889, lng: 2.3445, category: "boulangeries", day: "Jour 2",
                    phone: "01 42 23 78 45",
                    hours: "Mar-Dim: 7h30-19h, Lun: fermé",
                    specialty: "Pain levain naturel, sourdough artisanal, ouverture 2024"
                },
                
                // Marchés
                { 
                    name: "Marché Ornano", 
                    address: "Boulevard Ornano, 75018 Paris", 
                    description: "Marché de quartier authentique dans le 18e arrondissement. Ambiance locale avec produits frais, légumes, fruits et spécialités.", 
                    lat: 48.8933, lng: 2.3444, category: "marches", day: "Jour 2",
                    hours: "Mar/Ven/Dim: 8h-13h",
                    specialty: "Marché de quartier, produits frais locaux, ambiance authentique"
                },
                { 
                    name: "Marché Barbès", 
                    address: "Boulevard de la Chapelle, 75018 Paris", 
                    description: "Marché populaire multiculturel avec prix très accessibles. Atmosphère vibrante et cosmopolite.", 
                    lat: 48.8919, lng: 2.3598, category: "marches", day: "Jour 2",
                    hours: "Mer/Sam: 8h-13h",
                    specialty: "Prix abordables, multiculturalisme, produits d'Afrique et Moyen-Orient"
                },
                { 
                    name: "Marché Couvert La Chapelle", 
                    address: "10 rue de l'Olive, 75018 Paris", 
                    description: "Halle historique de style Baltard abritant commerces et restaurants. Architecture remarquable du 19e siècle.", 
                    lat: 48.8925, lng: 2.3601, category: "marches", day: "Jour 2",
                    phone: "01 46 07 39 90",
                    hours: "Mar-Sam: 8h30-19h30, Dim: 8h30-13h",
                    specialty: "Architecture Baltard, halle historique, commerces alimentaires"
                },
                { 
                    name: "Marché des Enfants Rouges", 
                    address: "39 Rue de Bretagne, 75003 Paris", 
                    description: "Plus ancien marché couvert de Paris (1615). Stands gastronomiques internationaux et produits de qualité.", 
                    lat: 48.8632, lng: 2.3636, category: "marches", day: "Jour 2",
                    phone: "01 42 77 96 40",
                    hours: "Mar-Jeu: 8h30-19h30, Ven-Sam: 8h30-20h, Dim: 8h30-14h",
                    specialty: "Plus ancien marché Paris 1615, gastronomie internationale, produits bio"
                },
                
                // Attractions principales
                { 
                    name: "Tour Eiffel", 
                    address: "Champ de Mars, 75007 Paris", 
                    description: "Monument emblématique de Paris (324m). Montée recommandée au coucher du soleil via approche Trocadéro.", 
                    lat: 48.8584, lng: 2.2945, category: "attractions", day: "Jour 3",
                    phone: "08 92 70 12 39",
                    hours: "9h30-23h45 (été), 9h30-22h45 (hiver)",
                    website: "https://www.toureiffel.paris",
                    specialty: "Monument 1889, 3 étages, vues panoramiques, éclairage nocturne"
                },
                { 
                    name: "Musée du Louvre", 
                    address: "Rue de Rivoli, 75001 Paris", 
                    description: "Plus grand musée du monde. Visite familiale recommandée 2h maximum, focus sur 3 œuvres principales.", 
                    lat: 48.8606, lng: 2.3376, category: "attractions", day: "Jour 4",
                    phone: "01 40 20 50 50",
                    hours: "9h-18h (mer/ven 21h45), mar fermé",
                    website: "https://www.louvre.fr",
                    specialty: "Joconde, Vénus de Milo, Victoire de Samothrace, pyramide"
                },
                { 
                    name: "Notre-Dame de Paris", 
                    address: "6 Parvis Notre-Dame, 75004 Paris", 
                    description: "Cathédrale gothique emblématique en reconstruction après l'incendie de 2019. Visite extérieure uniquement.", 
                    lat: 48.8530, lng: 2.3499, category: "attractions", day: "Jour 4",
                    phone: "01 42 34 56 10",
                    hours: "Visite extérieure uniquement (reconstruction)",
                    website: "https://www.notredamedeparis.fr",
                    specialty: "Architecture gothique, rosaces, reconstruction historique"
                },
                { 
                    name: "Catacombes de Paris", 
                    address: "1 Avenue du Colonel Henri Rol-Tanguy, 75014 Paris", 
                    description: "Ossuaire souterrain unique au monde. Réservation obligatoire, idéal pour enfants 12 ans et plus.", 
                    lat: 48.8338, lng: 2.3324, category: "attractions", day: "Jour 5",
                    phone: "01 43 22 47 63",
                    hours: "10h-20h30, lun fermé",
                    website: "https://www.catacombes.paris.fr",
                    specialty: "6 millions d'ossements, galeries souterraines, histoire unique"
                },
                { 
                    name: "Sacré-Cœur", 
                    address: "35 Rue du Chevalier de la Barre, 75018 Paris", 
                    description: "Basilique romano-byzantine au sommet de Montmartre. Vue panoramique exceptionnelle au coucher du soleil.", 
                    lat: 48.8867, lng: 2.3431, category: "attractions", day: "Jour 1",
                    phone: "01 53 41 89 00",
                    hours: "6h-22h30, dôme 8h30-20h (été)",
                    website: "https://www.sacre-coeur-montmartre.com",
                    specialty: "Architecture romano-byzantine, vue panoramique, dôme doré"
                },
                
                // Musées Famille
                { 
                    name: "Centre Pompidou", 
                    address: "Place Georges-Pompidou, 75004 Paris", 
                    description: "Musée d'art moderne avec architecture avant-gardiste. Vue panoramique depuis le dernier étage.", 
                    lat: 48.8606, lng: 2.3522, category: "musees", day: "Jour 4",
                    phone: "01 44 78 12 33",
                    hours: "11h-21h (mar fermé, jeu 23h)",
                    website: "https://www.centrepompidou.fr",
                    specialty: "Art moderne, architecture Renzo Piano, vue Paris, création contemporaine"
                },
                { 
                    name: "Musée Grévin", 
                    address: "10 Boulevard Montmartre, 75009 Paris", 
                    description: "Musée de cire mythique avec personnages célèbres. Idéal pour enfants de 12 ans et plus.", 
                    lat: 48.8719, lng: 2.3422, category: "musees", day: "Jour 3",
                    phone: "01 47 70 85 05",
                    hours: "10h-18h30 (week-end 19h)",
                    website: "https://www.grevin-paris.com",
                    specialty: "Figures de cire, personnages célèbres, expérience familiale, photos"
                },
                { 
                    name: "Cité des Sciences et de l'Industrie", 
                    address: "30 Avenue Corentin Cariou, 75019 Paris", 
                    description: "Plus grand musée des sciences d'Europe avec expériences interactives et hands-on pour toute la famille.", 
                    lat: 48.8957, lng: 2.3875, category: "musees", day: "Jour 5",
                    phone: "01 85 53 99 74",
                    hours: "10h-18h (dim 19h, lun fermé)",
                    website: "https://www.cite-sciences.fr",
                    specialty: "Sciences interactives, planétarium, expositions enfants, expérimentations"
                },
                { 
                    name: "Musée d'Orsay", 
                    address: "1 Rue de la Légion d'Honneur, 75007 Paris", 
                    description: "Collection impressionniste mondiale dans ancienne gare. Alternative au Louvre, moins bondé.", 
                    lat: 48.8600, lng: 2.3266, category: "musees", day: "Jour 4",
                    phone: "01 40 49 48 14",
                    hours: "9h30-18h (jeu 21h45, lun fermé)",
                    website: "https://www.musee-orsay.fr",
                    specialty: "Monet, Renoir, Van Gogh, architecture gare Belle Époque, impressionnisme"
                },
                
                // Parcs & Détente
                { name: "Parc des Buttes-Chaumont", address: "Rue Botzaris, 75019 Paris", description: "Récupération post-Catacombes, ponts Eiffel", lat: 48.8801, lng: 2.3828, category: "parcs", day: "Jour 5" },
                { name: "Jardins des Tuileries", address: "Place de la Concorde, 75001 Paris", description: "Récupération post-Louvre, trampolines", lat: 48.8634, lng: 2.3275, category: "parcs", day: "Jour 4" },
                { name: "Place des Vosges", address: "Place des Vosges, 75004 Paris", description: "Jour 2 Marais, plus ancienne place planifiée", lat: 48.8555, lng: 2.3665, category: "parcs", day: "Jour 2" },
                { name: "Champ de Mars", address: "75007 Paris", description: "Playground, vue Tour Eiffel, pique-nique", lat: 48.8553, lng: 2.2983, category: "parcs", day: "Jour 3" },
                { name: "Jardin du Luxembourg", address: "75006 Paris", description: "Bateaux jouets, aires de jeux, spectacles marionnettes", lat: 48.8462, lng: 2.3371, category: "parcs", day: "Jour 3" },
                { name: "Parc de la Villette", address: "211 Avenue Jean Jaurès, 75019 Paris", description: "Près Cité Sciences, grandes pelouses", lat: 48.8938, lng: 2.3905, category: "parcs", day: "Jour 5" },
                
                // Quartiers Authentiques
                { name: "Le Marais", address: "Rue de Rosiers, 75004 Paris", description: "Jour 2 - Médiéval, boutiques, cours cachées", lat: 48.8577, lng: 2.3615, category: "quartiers", day: "Jour 2" },
                { name: "Canal Saint-Martin", address: "Quai de Valmy, 75010 Paris", description: "Jour 5 PM - Écluses, vie locale", lat: 48.8719, lng: 2.3659, category: "quartiers", day: "Jour 5" },
                { name: "Montmartre Village", address: "Rue de l'Abreuvoir, 75018 Paris", description: "Éviter touristes, rues résidentielles", lat: 48.8867, lng: 2.3431, category: "quartiers", day: "Jour 1" },
                { name: "7e Arrondissement", address: "Rue Cler, 75007 Paris", description: "Après Tour Eiffel, marché piéton local", lat: 48.8584, lng: 2.3066, category: "quartiers", day: "Jour 3" },
                { name: "Île Saint-Louis", address: "75004 Paris", description: "Proche Notre-Dame, glaciers Berthillon, calme", lat: 48.8515, lng: 2.3555, category: "quartiers", day: "Jour 4" },
                
                // Magasins Leica Officiels
                { 
                    name: "Leica Store & Gallery Village Royal", 
                    address: "26 rue Boissy d'Anglas, 75008 Paris", 
                    description: "Flagship store de 300m² avec galerie d'exposition et café. Le plus grand magasin Leica de France.", 
                    lat: 48.8695, lng: 2.3259, category: "photo_leica", day: "Autres", 
                    website: "https://fr.leica-camera.com/magasins/leica-store-paris",
                    phone: "01 42 60 21 21",
                    hours: "Lun-Sam: 10h-19h, Dim: fermé",
                    specialty: "Flagship 300m², galerie, café, formations"
                },
                { 
                    name: "Leica Store Paris Beaumarchais", 
                    address: "52-54 Boulevard Beaumarchais, 75011 Paris", 
                    description: "Magasin historique depuis 1975. Service de réparation Leica certifié et expertise technique.", 
                    lat: 48.8564, lng: 2.3684, category: "photo_leica", day: "Autres", 
                    website: "https://fr.leica-camera.com/magasins/leica-store-paris",
                    phone: "01 48 87 88 08",
                    hours: "Mar-Sam: 10h-19h, Lun/Dim: fermé",
                    specialty: "Réparations certifiées, expertise technique"
                },
                { 
                    name: "Elle et Lui Photographie", 
                    address: "59 rue Condorcet, 75009 Paris", 
                    description: "Top 3 des revendeurs Leica en France. Spécialiste Hasselblad et moyen format haut de gamme.", 
                    lat: 48.8784, lng: 2.3411, category: "photo_leica", day: "Autres", 
                    website: "https://www.elle-et-lui-photo.com",
                    phone: "01 48 78 58 58",
                    hours: "Mar-Sam: 9h30-18h30, Lun/Dim: fermé",
                    specialty: "Top 3 dealer Leica France, Hasselblad, Phase One"
                },
                { 
                    name: "Photo Vincent Leica Boutique", 
                    address: "67 rue Sainte-Anne, 75002 Paris", 
                    description: "Boutique discrète sans enseigne. Collections muséales et appareils Leica vintage exceptionnels.", 
                    lat: 48.8675, lng: 2.3351, category: "photo_leica", day: "Autres", 
                    website: "https://www.photovincent.fr",
                    phone: "01 42 96 46 95",
                    hours: "Lun-Ven: 14h-18h, Sam: sur RDV",
                    specialty: "Collections muséales, pièces uniques, expertise"
                },
                
                // Photographie Vintage
                { 
                    name: "Odéon Occasions Photo", 
                    address: "73 Boulevard Beaumarchais, 75011 Paris", 
                    description: "Spécialiste des appareils vintage. Large sélection de Rolleiflex, Leicas d'occasion et objectifs rares.", 
                    lat: 48.8556, lng: 2.3695, category: "photo_vintage", day: "Autres", 
                    website: "https://www.odeon-photo.com",
                    phone: "01 47 00 58 58",
                    hours: "Mar-Sam: 10h-19h, Lun/Dim: fermé",
                    specialty: "Rolleiflex, Leicas vintage, objectifs rares"
                },
                { 
                    name: "Euro-Photo Beaumarchais", 
                    address: "89 Boulevard Beaumarchais, 75011 Paris", 
                    description: "Appareils photo vintage de qualité muséale. Toujours avec boîtes d'origine et documentation complète.", 
                    lat: 48.8545, lng: 2.3705, category: "photo_vintage", day: "Autres", 
                    website: "https://www.euro-photo.fr",
                    phone: "01 48 87 22 11",
                    hours: "Mar-Sam: 10h30-19h, Lun/Dim: fermé",
                    specialty: "Qualité musée, boîtes originales, documentation"
                },
                { 
                    name: "Le Moyen Format", 
                    address: "52 Boulevard Beaumarchais, 75011 Paris", 
                    description: "Exclusivement spécialisé dans les appareils moyen format. Hasselblad, Mamiya, Bronica, Pentax 67.", 
                    lat: 48.8564, lng: 2.3684, category: "photo_vintage", day: "Autres", 
                    website: "https://www.lemoyenformat.com",
                    phone: "01 43 38 27 27",
                    hours: "Mar-Sam: 11h-18h30, Lun/Dim: fermé",
                    specialty: "Moyen format exclusif: Hasselblad, Mamiya, Bronica"
                },
                
                // Quartiers Photo
                { name: "Boulevard Beaumarchais", address: "Boulevard Beaumarchais, 75011 Paris", description: "Boulevard de la Photographie", lat: 48.8555, lng: 2.3690, category: "photo_quartiers", day: "Autres" },
                { name: "Rue Condorcet", address: "Rue Condorcet, 75009 Paris", description: "Rue photographie dédiée", lat: 48.8784, lng: 2.3411, category: "photo_quartiers", day: "Autres" }
            ];
        }

        function getLondonLocations() {
            return [
                // Attractions principales
                { 
                    name: "Tower of London", 
                    address: "St Katharine's & Wapping, London EC3N 4AB", 
                    description: "Forteresse historique de 1066 abritant les Joyaux de la Couronne. Arrivée à l'ouverture recommandée.", 
                    lat: 51.5081, lng: -0.0759, category: "attractions", day: "Jour 2",
                    phone: "+44 20 3166 6000",
                    hours: "9h-17h30 (hiver), 9h-18h30 (été)",
                    website: "https://www.hrp.org.uk/tower-of-london",
                    specialty: "Joyaux Couronne, Yeoman Warders, corbeaux, histoire 1000 ans"
                },
                { 
                    name: "Tower Bridge", 
                    address: "Tower Bridge Rd, London SE1 2UP", 
                    description: "Pont-levis victorien emblématique avec sol en verre et vues spectaculaires sur la Tamise.", 
                    lat: 51.5055, lng: -0.0754, category: "attractions", day: "Jour 2",
                    phone: "+44 20 7403 3761",
                    hours: "9h30-18h",
                    website: "https://www.towerbridge.org.uk",
                    specialty: "Sol en verre, mécanisme victorien, vues Tamise, exposition"
                },
                { 
                    name: "British Museum", 
                    address: "Great Russell St, Bloomsbury, London WC1B 3DG", 
                    description: "Musée mondial gratuit avec collections extraordinaires. Momies égyptiennes et sacs d'activités pour enfants.", 
                    lat: 51.5194, lng: -0.1270, category: "attractions", day: "Jour 4",
                    phone: "+44 20 7323 8299",
                    hours: "10h-17h (ven 20h30)",
                    website: "https://www.britishmuseum.org",
                    specialty: "Entrée gratuite, momies égyptiennes, Pierre de Rosette, activités enfants"
                },
                { 
                    name: "Natural History Museum", 
                    address: "Cromwell Rd, South Kensington, London SW7 5BD", 
                    description: "Musée d'histoire naturelle gratuit avec squelettes de dinosaures et collections exceptionnelles.", 
                    lat: 51.4967, lng: -0.1764, category: "musees", day: "Jour 4",
                    phone: "+44 20 7942 5000",
                    hours: "10h-18h (dernière entrée 17h30)",
                    website: "https://www.nhm.ac.uk",
                    specialty: "Entrée gratuite, dinosaures, minéraux, architecture victorienne, planétarium"
                },
                { 
                    name: "Warner Bros Studio Tour", 
                    address: "Studio Tour Dr, Leavesden, Watford WD25 7LR", 
                    description: "Visite des studios Harry Potter avec décors authentiques. Transport en bus depuis Baker Street.", 
                    lat: 51.6906, lng: -0.4180, category: "attractions", day: "Jour 5",
                    phone: "+44 345 084 0900",
                    hours: "9h30-18h30 (horaires variables)",
                    website: "https://www.wbstudiotour.co.uk",
                    specialty: "Studios Harry Potter, décors authentiques, costumes, baguettes magiques"
                },
                { 
                    name: "Westminster Abbey", 
                    address: "20 Deans Yd, Westminster, London SW1P 3PA", 
                    description: "Abbaye gothique royal où ont lieu les couronnements. Tombes de personnages historiques célèbres.", 
                    lat: 51.4994, lng: -0.1273, category: "attractions", day: "Jour 3",
                    phone: "+44 20 7222 5152",
                    hours: "9h30-16h30 (sam 14h30)",
                    website: "https://www.westminster-abbey.org",
                    specialty: "Couronnements royaux, Poets' Corner, architecture gothique, histoire"
                },
                { 
                    name: "Big Ben & Houses of Parliament", 
                    address: "Westminster, London SW1A 0AA", 
                    description: "Icône de Londres avec la célèbre horloge Big Ben. Visite extérieure pour photos mémorables.", 
                    lat: 51.4994, lng: -0.1245, category: "attractions", day: "Jour 3",
                    phone: "+44 20 7219 4272",
                    hours: "Visite extérieure libre, tours guidées sur réservation",
                    website: "https://www.parliament.uk",
                    specialty: "Big Ben, architecture néo-gothique, parlement britannique"
                },
                
                // Marchés & Quartiers
                { 
                    name: "Borough Market", 
                    address: "8 Southwark St, London SE1 1TL", 
                    description: "Marché gastronomique historique de plus de 1000 ans. Producteurs artisanaux, cuisine internationale et dégustations.", 
                    lat: 51.5055, lng: -0.0909, category: "marches", day: "Jour 2",
                    phone: "+44 20 7407 1002",
                    hours: "Mer-Jeu: 10h-17h, Ven: 10h-18h, Sam: 8h-17h",
                    website: "https://boroughmarket.org.uk",
                    specialty: "Marché 1000 ans, producteurs artisanaux, dégustation, cuisine mondiale"
                },
                { name: "Greenwich", address: "Greenwich, London", description: "Jour 3 - Village maritime, méridien premier, bateau Tamise", lat: 51.4826, lng: -0.0077, category: "quartiers", day: "Jour 3" },
                { name: "Covent Garden", address: "Covent Garden, London WC2E", description: "Jour 6 - Marché, artistes rue, dernière journée", lat: 51.5118, lng: -0.1226, category: "quartiers", day: "Jour 6" },
                { name: "South Bank", address: "South Bank, London", description: "Jour 1 soir - Chemin Tamise gratuit, artistes rue", lat: 51.5045, lng: -0.1086, category: "quartiers", day: "Jour 1" },
                { 
                    name: "Camden Market", 
                    address: "Camden Lock Pl, Camden Town, London NW1 8AF", 
                    description: "Marché alternatif emblématique avec boutiques vintage, artisanat, street food. Parfait pour adolescents.", 
                    lat: 51.5444, lng: -0.1471, category: "marches", day: "Jour 5",
                    phone: "+44 20 7485 5511",
                    hours: "Lun-Dim: 10h-18h",
                    website: "https://www.camdenmarket.com",
                    specialty: "Marché alternatif, vintage, artisanat, culture underground, street food"
                },
                { name: "Notting Hill", address: "Notting Hill, London", description: "Portobello Road, maisons colorées, pubs locaux", lat: 51.5152, lng: -0.2056, category: "quartiers", day: "Jour 6" },
                
                // Parcs & Détente
                { name: "Hyde Park", address: "Hyde Park, London", description: "Jour 4 PM - Serpentine Lake, bateaux, pelouses", lat: 51.5074, lng: -0.1657, category: "parcs", day: "Jour 4" },
                { name: "Greenwich Park", address: "Greenwich, London SE10 8QY", description: "Jour 3 - Espace course illimité, vues", lat: 51.4768, lng: 0.0005, category: "parcs", day: "Jour 3" },
                { name: "Hampstead Heath", address: "Hampstead, London NW3", description: "Optionnel - Authentique quartier résidentiel", lat: 51.5581, lng: -0.1644, category: "parcs", day: "Autres" },
                { name: "Regent's Park", address: "Chester Rd, London NW1 4NR", description: "Zoo Londres, aire jeux Diana Memorial", lat: 51.5313, lng: -0.1563, category: "parcs", day: "Jour 5" },
                
                // Musées Familiaux
                { name: "Science Museum", address: "Exhibition Rd, South Kensington, London SW7 2DD", description: "Jour 4 - Interactif, Wonderlab £15", lat: 51.4978, lng: -0.1745, category: "musees", day: "Jour 4" },
                { name: "HMS Belfast", address: "The Queen's Walk, London SE1 2JH", description: "Jour 2 PM - Navire WWII interactif", lat: 51.5065, lng: -0.0814, category: "musees", day: "Jour 2" },
                { name: "National Maritime Museum", address: "Park Row, Greenwich, London SE10 9NF", description: "Jour 3 - Histoire maritime", lat: 51.4810, lng: -0.0052, category: "musees", day: "Jour 3" },
                { name: "Tate Modern", address: "Bankside, London SE1 9TG", description: "Art moderne gratuit, vue Tamise", lat: 51.5076, lng: -0.0994, category: "musees", day: "Jour 1" },
                { name: "London Transport Museum", address: "Covent Garden Piazza, London WC2E 7BB", description: "Histoire transports, interactif enfants", lat: 51.5118, lng: -0.1226, category: "musees", day: "Jour 6" },
                
                // Magasins Leica Officiels
                { 
                    name: "Leica Store London Mayfair", 
                    address: "64-66 Duke Street, London W1K 6JD", 
                    description: "Flagship store UK avec galerie d'exposition. Showroom de 200m² au cœur de Mayfair avec tous les derniers modèles.", 
                    lat: 51.5130, lng: -0.1454, category: "photo_leica", day: "Autres", 
                    website: "https://uk.leica-camera.com/stores/leica-store-mayfair",
                    phone: "+44 20 7629 1351",
                    hours: "Mon-Sat: 10am-6pm, Sun: 12pm-5pm",
                    specialty: "Flagship UK, galerie, derniers modèles, formations"
                },
                { 
                    name: "DJI Hasselblad Flagship", 
                    address: "52 Regent Street, London W1B 5RL", 
                    description: "Nouveau flagship store 2025. Expérience immersive Hasselblad avec studio de test et expertise moyen format.", 
                    lat: 51.5125, lng: -0.1394, category: "photo_leica", day: "Autres", 
                    website: "https://www.hasselblad.com/stores",
                    phone: "+44 20 7734 7291",
                    hours: "Mon-Sat: 10am-7pm, Sun: 12pm-6pm",
                    specialty: "Flagship Hasselblad, studio test, moyen format"
                },
                
                // Photographie Vintage/Spécialistes
                { 
                    name: "Park Cameras London", 
                    address: "34 Rathbone Place, London W1T 1JN", 
                    description: "Magasin familial depuis plus de 50 ans. Expertise reconnue et service client exceptionnel.", 
                    lat: 51.5188, lng: -0.1345, category: "photo_vintage", day: "Autres", 
                    website: "https://www.parkcameras.com",
                    phone: "+44 20 7636 6525",
                    hours: "Mon-Sat: 9am-6pm, Sun: fermé",
                    specialty: "Familial 50+ ans, expertise, service client"
                },
                { 
                    name: "The Classic Camera", 
                    address: "2 Pied Bull Yard, London WC1A 2JR", 
                    description: "Spécialiste télémètres et appareils vintage depuis plus de 20 ans. Réparations et restaurations expert.", 
                    lat: 51.5156, lng: -0.1298, category: "photo_vintage", day: "Autres", 
                    website: "https://www.classiccamera.co.uk",
                    phone: "+44 20 7831 3640",
                    hours: "Mon-Fri: 10am-6pm, Sat: 10am-5pm, Sun: fermé",
                    specialty: "Télémètres, vintage, réparations expert"
                },
                { 
                    name: "Wex Photo Video London", 
                    address: "Commercial Road, Whitechapel, London", 
                    description: "Le plus grand magasin photo du Royaume-Uni. Stock immense et prix compétitifs sur toutes les marques.", 
                    lat: 51.5118, lng: -0.0648, category: "photo_vintage", day: "Autres", 
                    website: "https://www.wexphotovideo.com",
                    phone: "+44 20 7790 8522",
                    hours: "Mon-Sat: 9am-6pm, Sun: 11am-5pm",
                    specialty: "Plus grand UK, stock immense, prix compétitifs"
                },
                
                // Quartiers Photo
                { name: "Tottenham Court Road", address: "Tottenham Court Road, London", description: "District photo traditionnel", lat: 51.5188, lng: -0.1345, category: "photo_quartiers", day: "Autres" }
            ];
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initApp);

        // Service Worker Registration - PWA Support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('PWA: Service Worker enregistré avec succès');
                        
                        // Vérifier les mises à jour
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Nouvelle version disponible
                                    showUpdateNotification();
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('PWA: Échec d\'enregistrement du Service Worker:', error);
                    });
            });
        }

        // Notification de mise à jour
        function showUpdateNotification() {
            if (confirm('🔄 Une nouvelle version est disponible ! Recharger pour mettre à jour ?')) {
                window.location.reload();
            }
        }

        // Install prompt pour PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA: Install prompt déclenché');
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });

        function showInstallButton() {
            // Créer bouton d'installation si pas déjà présent
            if (!document.getElementById('install-btn')) {
                const installBtn = document.createElement('button');
                installBtn.id = 'install-btn';
                installBtn.innerHTML = '📱 Installer l\'app';
                installBtn.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #667eea;
                    color: white;
                    border: none;
                    padding: 12px 20px;
                    border-radius: 25px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                    z-index: 10000;
                    transition: all 0.3s ease;
                `;
                
                installBtn.addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const result = await deferredPrompt.userChoice;
                        if (result.outcome === 'accepted') {
                            console.log('PWA: Installation acceptée');
                        }
                        deferredPrompt = null;
                        installBtn.remove();
                    }
                });
                
                installBtn.addEventListener('mouseover', () => {
                    installBtn.style.transform = 'translateY(-2px)';
                    installBtn.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.4)';
                });
                
                installBtn.addEventListener('mouseout', () => {
                    installBtn.style.transform = 'translateY(0)';
                    installBtn.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.3)';
                });
                
                document.body.appendChild(installBtn);
                
                // Masquer après 10 secondes si pas utilisé
                setTimeout(() => {
                    if (document.getElementById('install-btn')) {
                        installBtn.style.opacity = '0';
                        setTimeout(() => installBtn.remove(), 300);
                    }
                }, 10000);
            }
        }

        // Détection d'installation réussie
        window.addEventListener('appinstalled', () => {
            console.log('PWA: Installation réussie !');
            const installBtn = document.getElementById('install-btn');
            if (installBtn) installBtn.remove();
        });

        // Gestion du mode iOS standalone
        if (window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) {
            console.log('PWA: Mode standalone détecté');
            document.body.classList.add('pwa-standalone');
        }
    </script>
</body>
</html>